Episode Embed & Sail Flow Guide

Purpose
- Describe how to build episode embeds, XP awarding rules, reward conversion for duplicates, button customIds, and progression checks used in the sailing/story system.

Files of interest
- events/interactionCreate.js — interaction handler and sail flow (battle helpers at module scope)
- commands/sail.js — slash command that shows the current sail progress / episode intro
- models/SailProgress.js — per-user sail progress and awardedXp tracking
- models/Progress.js — player collection and team data

Episode embed construction
- Title: Use bold formatting for episode name/number. Example: `**Episode Title — Episode N**`.
- Description: Provide a short narrative, then a `**Possible rewards:**` section listing money, chests, card rewards and special-case items.
- Image: Use `.setImage(url)` to display a banner for the episode.
- XP line: Always compute and inject an `xpAmount` variable before building the embed. Use consistent difficulty mapping:
  - easy: 10 XP
  ```plaintext
  Episode Embed & Sail Flow Guide

  Purpose
  - Describe how to build episode embeds, XP awarding rules, reward conversion for duplicates, button customIds, and progression checks used in the sailing/story system.

  Files of interest
  - events/interactionCreate.js — interaction handler and sail flow (battle helpers at module scope)
  - commands/sail.js — slash command that shows the current sail progress / episode intro
  - models/SailProgress.js — per-user sail progress and awardedXp tracking
  - models/Progress.js — player collection and team data

  Episode stages (four stage types)
  - Embed stages: Narrative or informational embeds (no combat). Examples: scene-setting, cutscenes, character dialogue. Implement by sending a public embed, advancing `session.phase`, and calling `startSailTurn(sessionId, channel)` after a short delay (1-2s) to continue progression. Embed stages must include a grey "Next Stage" button (use `ButtonStyle.Secondary`) labelled `Next Stage` (customId pattern: `sail_next:<sessionId>:<phase>`). Embeds should use an island-appropriate accent color (for Orange Town use `0xFA8628`).
  - Decision stages: Places where the player must click a button to continue or choose a path. These are UI steps that may lead to another embed or a fight. Implement by sending an embed with a `Next` or choice button (customId using `sail_ep_choice:<sessionId>:<choice>` or `sail_next:<sessionId>`). Collect the response and then advance `session.phase` accordingly.
  - Fight stages: Combat encounters driven by `startSailTurn`. These spawn `session.enemies` and use the regular sail combat UI (select char, choose action, select target).
  - Accuracy embed stages (new): Timed accuracy interactions where a visible progress bar moves from start to end and the session owner must click a provided button to stop it. Requirements:
    - Display a progress bar in the embed (or as ephemeral UI) that updates every 0.5s from 0% to 100%.
    - Provide a single action button (suggested customId pattern: `sail_accuracy:<sessionId>:<phase>`; label example: `Now!`).
    - The user must click the button to stop the bar; the server measures how close the stop time is to the bar's end.
    - Define an "accuracy window" (e.g. last X% or last Y ms) that counts as success; clicks outside the window count as failure.
    - On success, advance `session.phase` and continue normal flow; on failure record a loss for this episode and apply the configured cooldown (default: 5 minutes) before the player can `op sail` again.
    - Accuracy embeds should be permission-checked so only the session owner may click the button; defer the interaction and then resolve success/failure server-side.
    - Scope note: Accuracy embeds may be episode-specific. If an accuracy check only affects a single episode (for example Episode 7), document that in the episode's section and ensure `startSailTurn` handles the episode-scoped outcome.

  General rules
  - Represent story progression with `session.phase` integers. Each phase maps to a stage (embed/decision/fight). `startSailTurn` should switch behavior based on `session.episode` and `session.phase`.
  - After sending an embed (embed stage) advance `session.phase` then call `startSailTurn(sessionId, channel)` after 1-2000ms so the next stage appears (narrative -> fight or next embed).
  - Decision stages should wait for the user's button click; on click defer the interaction, advance `session.phase`, and call `startSailTurn` to continue.
  - Fight stages should set `session.enemies` and appropriate `session.phase` so that when enemies are all defeated the code advances to the next phase (either an embed, decision, or reward stage) instead of ending the episode prematurely.

  Episode 4 — Luffy's Past! (Orange Town)
  Overview
  - Title: Episode 4 - Luffy's Past! The Red-Haired Shanks Appears
  - Image: https://files.catbox.moe/rf1czx.webp
  - Theme: Explains the origin of Luffy's straw hat and features Buggy, Higuma, and the Lord of the Coast.

  Possible rewards (per difficulty)
  - Money: 100 - 200 beli (scaled by difficulty)
  - Chest(s): 1 C-tier chest (count may vary per difficulty)
  - Item: 1x Straw Hat item blueprint (`Strawhat_blueprint_s_01`) — blueprint, not the final weapon
  - Exclusive (hard-only): `Higuma` card (enemy becomes collectible on hard) and `Lord of the Coast` (hard-only)

  Episode 4 stages (canonical phase mapping)
  - Phase 6 (Embed / Rewards stage): Shanks rescues Luffy but loses his left arm (embed). Show reward embed summarizing loot depending on difficulty. Include image: https://files.catbox.moe/kfouk3.webp
    - UI: Rewards embed should use Orange Town accent color `0xFA8628` and include a grey `Next Stage` or `Claim Rewards` button (`ButtonStyle.Secondary`) for the session owner. On click, defer the interaction and run the reward distribution logic in `endSailBattle` for `session.episode === 4`.

  Episode 5 — Fear, Mysterious Power! Pirate Clown Captain Buggy! (Orange Town)
  Overview
  - Title: Episode 5 - Fear, Mysterious Power! Pirate Clown Captain Buggy!
  - Image: https://files.catbox.moe/euwxw2.webp
  - Author (embed field for all non-fight embeds): Orange town - East Blue
  - Accent color (non-fight embeds): 0xFA8628

  Possible rewards (per difficulty)
  - Money: 100 - 200 beli (scaled by difficulty)
  - Chest(s): 1 C-tier chest

  Episode 5 stages (canonical phase mapping)
  - Phase 1 (Embed stage): Stage 1: Alliance with Nami
    - Image: https://files.catbox.moe/tr1o0x.webp
    - Description: After collaborating with Luffy to escape from the Buggy Pirates, they find refuge at a restaurant, where Nami reveals her goal of collecting 100 million Berries and demonstrates her navigation skills.
    - UI: Embed (author: Orange town - East Blue, color `0xFA8628`) with a grey `Next Stage` button (customId: `sail_next:<sessionId>:2`). On click, advance `session.phase = 2` and call `startSailTurn`.

  - Phase 2 (Embed stage): Stage 2: Betrayal!
    - Image: https://files.catbox.moe/ikhd91.webp
    - Description: Nami betrays Luffy, tying him up and handing him to the Buggy Pirates. Buggy locks Luffy in a cage and readies a Buggy Ball; pirates fire into the distance destroying a row of houses. Zoro notices the explosion as he arrives in town.
    - UI: Embed (author: Orange town - East Blue, color `0xFA8628`) with a grey `Next Stage` button (customId: `sail_next:<sessionId>:3`). On click, advance `session.phase = 3` and call `startSailTurn`.

  - Phase 3 (Decision stage): Stage 3: Save Luffy?
    - Image: https://files.catbox.moe/arz1tu.webp
    - Description: Buggy orders Nami to fire a Buggy Ball at Luffy — will she obey?
    - Choices (buttons):
      - `No` (customId: `sail_ep_choice:<sessionId>:save_no`) — consequences: `-1 karma`, leads to `secret death stage` (phase 99)
      - `Yes` (customId: `sail_ep_choice:<sessionId>:save_yes`) — consequences: `+1 karma`, advances to Phase 4 (set `session.phase = 4`)
    - UI: Decision buttons must verify session owner. On click defer the interaction and call `startSailTurn` to continue.

  - Phase 4 (Fight stage): Mini Fight vs Buggy
    - Enemy: Buggy
    - Health: 160
    - Attack: 20 - 35
    - Special (used at start of Buggy's turn): Bara Bara festival — 100 - 140 attack
    - Implementation: spawn Buggy in `session.enemies` with difficulty multipliers on HP and attack ranges. On victory, present rewards embed and a `Next Sail` button to finish the episode.

  - Phase 99 (Secret stage - death): You Died!
    - Image: https://files.catbox.moe/c9v55d.webp
    - Description (embed): You Died! What did you think would have happened? Try not killing yourself next time!
    - Effect: This counts as a battle loss (apply 5 minute cooldown, no rewards). Advance session/end accordingly as a loss.

  Notes
  - Fight stages should not include the `Author` or `color` styling; keep those only on narrative embeds and decisions per the guide.

  Episode 6 — Desperate Situation! Beast Tamer Mohji vs. Luffy! (Orange Town)
  Overview
  - Title: Episode 6 - Desperate Situation! Beast Tamer Mohji vs. Luffy!
  - Image: https://files.catbox.moe/gzwyfp.webp
  - Author (embed field for all non-fight embeds): Orange town - East Blue
  - Accent color (non-fight embeds): 0xFA8628

  Possible rewards (per difficulty)
  - Money: 100 - 200 beli (scaled by difficulty)
  - Chest(s): 1 C-tier chest
  - Cards: 1x Chouchou card, 1x Boodle card
  - Hard-only exclusives: 1x Mohji card, 1x Richie card

  Episode 6 stages (canonical phase mapping)
  - Phase 1 (Embed stage): Chouchou the dog
    - Image: https://files.catbox.moe/4ci3uu.webp
    - Description: Luffy meets Chouchou, a dog defending a shop. The mayor explains Chouchou's devotion; Nami arrives with the key to Luffy's cage but Chouchou swallows the key before it can be used.
    - UI: Embed (author: Orange town - East Blue, color `0xFA8628`) with a grey `Next Stage` button (customId: `sail_next:<sessionId>:2`). On click, advance `session.phase = 2` and call `startSailTurn`.

  - Phase 2 (Fight stage): Fight vs Mohji
    - Image (optional for fight embed): https://files.catbox.moe/ (use the provided fight image if available)
    - Enemy: Mohji (with Richie as beast partner if desired per difficulty)
    - Health: 130
    - Attack: 14 - 24
    - Implementation: spawn Mohji in `session.enemies`. Apply difficulty multipliers; on victory advance `session.phase = 3`.

  - Phase 3 (Embed stage): Buggy’s wrath
    - Image: https://files.catbox.moe/khynek.webp
    - Description: Buggy fires a Buggy Ball which destroys the mayor's house; Zoro is caught in the blast but survives. The mayor confronts Buggy for his callous invasion.
    - UI: Embed (author: Orange town - East Blue, color `0xFA8628`) with a grey `Next Stage` or `Claim Rewards` button. On click, present the reward embed and a `Next Sail` button to finish the episode.

  Notes
  - Include the Chouchou and Boodle cards as normal drops; award Mohji/Richie cards only on hard difficulty via `endSailBattle` for `session.episode === 6`.

  End of appended episodes
  - Phase 1 (Embed stage): Nami tricks the three Buggy Pirates. Send an episode-style embed after the player clicks "I'm ready!". (Image: https://files.catbox.moe/rf1czx.webp)
    - Description: The burglar girl's dinghy is discovered by three Buggy Pirates while at sea. Pretending to be a desperate, stranded woman, she lures the pirates on her boat with promises of treasure. However, she secretly boards the Buggy Pirates' boat and sails away from them without their knowledge. The ship the pirates are on capsizes from a windstorm.
    - UI: Embed (use color `0xFA8628` for Orange Town) with the provided image and a grey `Next Stage` button (`ButtonStyle.Secondary`) labeled `Next Stage` (customId: `sail_next:<sessionId>:2`). Only the session owner may click this button; on click defer the interaction, advance `session.phase` to 2 and call `startSailTurn`.

  - Phase 2 (Fight stage): Fight 3 Buggy Pirates (combat). Each pirate stats:
    - Health: 70
    - Attack: 7 - 13
    - Implementation: spawn 3 enemies in `session.enemies` with the above stats multiplied by difficulty multipliers (easy=1, medium=1.25, hard=1.5). After victory, set `session.phase = 3` and present a `Next` button (or auto-advance to Phase 3 embed after short delay).

  - Phase 3 (Embed stage): Luffy's backstory embed. (Image: https://files.catbox.moe/n53m1z.webp)
    - Description: In his childhood Luffy befriended Shanks... Higuma abducts Luffy; Sea King attack; Shanks intervenes later.
    - UI: Embed (use color `0xFA8628` for Orange Town) with the provided image and a grey `Next Stage` button (`ButtonStyle.Secondary`) labeled `Next Stage` (customId: `sail_next:<sessionId>:4`). Only the session owner may click; on click defer, set `session.phase = 4` and call `startSailTurn`.

  - Phase 4 (Fight stage): Fight Higuma (solo or with small support). Stats:
    - Higuma — Health: 105, Attack: 14 - 24
    - Implementation: spawn Higuma in `session.enemies`. After victory advance `session.phase = 5` and show `Next` button.

  - Phase 5 (Fight stage): Fight Lord of the Coast. Stats:
    - Lord of the Coast — Health: 160, Attack: 20 - 30
    - Implementation: spawn Lord of the Coast in `session.enemies`. After victory advance `session.phase = 6`.

  - Phase 6 (Embed / Rewards stage): Shanks rescues Luffy but loses his left arm (embed). Show reward embed summarizing loot depending on difficulty. Include image: https://files.catbox.moe/kfouk3.webp
    - UI: Rewards embed should use Orange Town accent color `0xFA8628` and include a grey `Next Stage` or `Claim Rewards` button (`ButtonStyle.Secondary`) for the session owner. On click, defer the interaction and run the reward distribution logic in `endSailBattle` for `session.episode === 4`.

  Notes for implementers
  - Do not mark the episode completed after Phase 2. Ensure that `endSailBattle` checks `session.phase` and `session.episode` to determine whether to advance to the next phase or conclude the episode. For Episode 4, when the Buggy Pirates (Phase 2) are defeated, the code must set `session.phase = 3` and present the Phase 3 embed instead of calling `endSailBattle(..., true)` to finish the episode.
  - If using a helper like `startEpisode4Stage2` to spawn the Buggy Pirates, initialize `session.phase = 2` (or the next phase) only if appropriate — prefer explicit phase assignments in the flow so `startSailTurn` doesn't re-run the same spawn or terminate early.
  - Use `session.userId` and `session.sessionId` consistent with other sail flows. For decision/next buttons prefer `sail_next:<sessionId>:<phase>` or similar pattern to collect the user's click and advance `session.phase` safely.
  - Apply difficulty multipliers to enemy HP and attack ranges when creating enemy objects.
  - For hard-only collectible enemies (Higuma / Lord of the Coast), award the card via `endSailBattle` only when `session.difficulty === 'hard'` (or numeric diff mapping). Otherwise, they are regular enemies that drop no collectible card.

  Example quick checklist when adding Episode 4 code
  - Add Episode 4 intro embed in `commands/sail.js` with the same pattern as other episodes (xp mapping, rewards list, image).
  - Register `sail_battle_ep4:<userId>:start` handler in `events/interactionCreate.js` to initialize a `session` with `episode: 4, phase: 1` and call `startSailTurn(sessionId, channel)`.
  - Implement Phase handlers in `startSailTurn` (or helper functions): Phase 1 -> send embed -> wait for `sail_next` click -> Phase 2 spawn enemies; Phase 2 -> on victory set phase 3; Phase 3 -> embed -> Phase 4 spawn Higuma; Phase 4 -> on victory set phase 5; Phase 5 -> spawn Lord -> on victory advance to rewards.
  - Implement reward branch in `endSailBattle` for `session.episode === 4` to give the straw hat blueprint and hard-mode exclusive cards as described.

  Episode implementation sequence (canonical)
  - 1) `commands/sail.js` displays the episode intro embed (title, image, rewards, `Sail to Episode N` button).
  - 2) User clicks the `Sail to Episode N` button -> the `events/interactionCreate.js` handler for `sail_battle_epN:<userId>:start` must immediately acknowledge the interaction (use `deferUpdate()` or `update()`), then call a helper like `startEpisodeNStage2(userId, interaction)` to initialize the runtime session.
  - 3) `startEpisodeNStage2` should create and store the `session` in `global.SAIL_SESSIONS` with fields: `userId`, `sessionId`, `cards`, `enemies` (empty if phase 1 is an embed), `phase: 1`, `episode: N`, `difficulty`, `channelId`, and any other flags. Do NOT spawn the first narrative embed from the command handler; leave progression to `startSailTurn` to centralize logic.
  - 4) Call `startSailTurn(sessionId, channel)` once the session is stored. `startSailTurn` is responsible for sending embed stages, spawning enemies for fight stages, creating UI buttons and collectors, and setting `session.phase` to the next numeric phase when appropriate.
  - 5) For embed stages `startSailTurn` should send a styled embed with a grey `Next Stage` (`sail_next:<sessionId>:<phase>`) button and return. The `sail_next` button handler must verify the session owner, defer the interaction, set `session.phase` to the requested next phase, and call `startSailTurn` again.
  - 6) For fight stages `startSailTurn` should set `session.enemies`, apply difficulty multipliers, and then send the battle embed with action/Haki/heal buttons. After the fight is resolved (enemies all dead), `startSailTurn` must detect that and either advance to the next phase (embed/decision/fight) or call `endSailBattle(sessionId, channel, true)` only when the episode is truly finished.

  This canonical sequence keeps episode control centralized in `startSailTurn`, avoids duplicate embeds, and makes phase transitions explicit and testable.

  Implementation requirement: whenever new episode content is added to this guide, the implementer must also add the real code implementing that episode into `events/interactionCreate.js` (exported helpers like `startEpisodeNStage2` and the matching `sail_battle_epN` button handlers). The guide entries should be accompanied by working code so episodes are playable.

  Testing guidance
  - Walk through Episode 4 as a test user on each difficulty to confirm:
    - Phase transitions (embed -> fight -> embed -> fight -> fight -> rewards).
    - `Next`/decision buttons work and only the session owner can click them.
    - Hard-mode exclusives awarded only on hard.

  Contact
  - For clarifications or changes to reward conversions (e.g. convert to XP instead of level), update the conversion block in `events/interactionCreate.js` and document the change here.

  ```
  4. Confirm Episode 2 enemies are Helmeppo/Marine and not Poppoko/Alvida.
